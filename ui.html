<style>
  .app {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  input[type=radio] {
    display: none;
  }

  .flex {
    display: flex;
    gap: 4px;
  }

  .rate {
    width: 100%;
    display: flex;
    flex-direction: row-reverse;
    width: fit-content;
  }

  .label {
    color: #ccc;
    cursor: pointer;
    font-size: 24px;
  }

  .label:hover,
  .label:hover~.label {
    color: #ffe400;
  }

  input[name="rate"]:checked~.label {
    color: #ffe400;
  }

  #review {
    width: 100%;
    border-radius: 6px;
    height: 96px;
    border-color: #ccc;
    resize: none;
    padding: 12px;
    font-family: sans-serif;
  }

  .btn-base {
    width: 100%;
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    color: white;
  }

  .btn-primary {
    background-color: rgb(14, 165, 233);
  }

  .btn-secondary {
    border: 1px solid #d4d4d4;
    color: #171717;
  }
</style>

<div class="app">
  <div class="rate">
    <input type="radio" id="1" name="rate" value="1" />
    <label class="label" for="1">
      <svg fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z">
        </path>
      </svg>
    </label>
    <input type="radio" id="2" name="rate" value="2" />
    <label class="label" for="2">
      <svg fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z">
        </path>
      </svg>
    </label>
    <input type="radio" id="3" name="rate" value="3" />
    <label class="label" for="3">
      <svg fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z">
        </path>
      </svg>
    </label>
    <input type="radio" id="4" name="rate" value="4" />
    <label class="label" for="4">
      <svg fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z">
        </path>
      </svg>
    </label>
    <input type="radio" id="5" name="rate" value="5" />
    <label class="label" for="5">
      <svg fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z">
        </path>
      </svg>
    </label>
  </div>

  <textarea id="review"></textarea>
  <div class="flex" style="align-items: center;">
    <input type="checkbox" id="anonymous" name="anonymous" />
    <label style="font-family: sans-serif; font-size: 12px;" for="anonymous">Anonymous</label>
  </div>
  <!-- <button id="confirm">确定</button> -->
  <a id="download" style="display: none;"></a>
</div>

<script>
  const deleteReview = (id) => parent.postMessage({ pluginMessage: { type: "DELETE_REVIEW", payload: { id } } }, "*");
  const editReview = ({ id, text, rate, anonymous }) => parent.postMessage({ pluginMessage: { type: "EDIT_REVIEW", payload: { id, text, rate, anonymous } } }, "*")

  window.addEventListener("message", (ev) => {
    const { type, payload } = ev.data.pluginMessage;

    if (type === "DOWNLOAD_DATA") {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload))
      const dl = document.querySelector("#download")
      dl.setAttribute("href", dataStr)
      dl.setAttribute("download", "reviews.json");
      dl.click();
    } else if (type === "CHANGE_VIEW") {
      if (payload === "ADD_REVIEW") {
        const confirmBtn = document.createElement("button");
        confirmBtn.innerHTML = "Confirm"
        confirmBtn.id = "confirm"
        confirmBtn.className = "btn-base btn-primary"

        confirmBtn.onclick = () => {
          const text = document.querySelector("#review").value;
          const rate = document.querySelector('input[name="rate"]:checked').value;
          const anonymous = document.querySelector('input[name="anonymous"]').checked;

          parent.postMessage({
            pluginMessage: {
              type: "ADD_REVIEW",
              payload:
                { text, rate: 6 - parseInt(rate), anonymous }
            }
          }, "*");
        }

        const app = document.querySelector(".app");
        app.appendChild(confirmBtn);

      } else if (payload === "EDIT_REVIEW") {
        const { review: { text, rate, id, anonymous } } = ev.data.pluginMessage;
        const review = document.querySelector("#review");
        review.innerHTML = text;
        const radio = document.querySelector(`input[id="${6 - rate}"]`)
        radio.checked = true
        const checkbox = document.querySelector("input[name='anonymous']")
        checkbox.checked = anonymous

        const saveBtn = document.createElement("button");
        saveBtn.innerHTML = "Save"
        saveBtn.id === "save"
        saveBtn.className = "btn-base btn-primary"

        saveBtn.onclick = () => {
          const text = document.querySelector("#review").value;
          const rate = document.querySelector('input[name="rate"]:checked').value;
          const anonymous = document.querySelector('input[name="anonymous"]').checked
          editReview({ id, text, rate: 6 - parseInt(rate), anonymous })
        }

        const delBtn = document.createElement("button");
        delBtn.innerHTML = "Delete"
        delBtn.id = "delete"
        delBtn.className = "btn-base btn-secondary"

        delBtn.onclick = () => { deleteReview(id) }

        const flex = document.createElement("div")
        flex.className = "flex"
        flex.style.display = "flex"
        flex.style.gap = "4px";
        flex.style.width = "100%"

        flex.appendChild(saveBtn)
        flex.appendChild(delBtn)

        const app = document.querySelector(".app")
        app.appendChild(flex)
      }
    }
  })

  // const confirmBtn = document.querySelector("#confirm");

  // confirmBtn.onclick = () => {
  //   const text = document.querySelector("#review").value;
  //   const rate = document.querySelector('input[name="rate"]:checked').value;

  //   parent.postMessage({ pluginMessage: { type: "ADD_REVIEW", payload: { text, rate: 6 - parseInt(rate) } } }, "*");
  // };
</script>